#!/usr/bin/env bash

# =============================================
# –û–ø–∏—Å–∞–Ω–∏–µ: –°–±–æ—Ä –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤—Ö–æ–¥–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
# =============================================

# –§–∞–π–ª –¥–ª—è –≤–µ–¥–µ–Ω–∏—è –∂—É—Ä–Ω–∞–ª–æ–≤
readonly LOG_PATH="/var/log/login_activity.log"

# –§—É–Ω–∫—Ü–∏—è: –í—ã–≤–æ–¥ –≤ –ª–æ–≥ –∏ –Ω–∞ —ç–∫—Ä–∞–Ω
function log() {
    local message="$1"
    echo -e "${message}" | tee -a "${LOG_PATH}"
}

# –§—É–Ω–∫—Ü–∏—è: –ü–æ–¥—Å—á—ë—Ç –≤—Ö–æ–¥–æ–≤ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞
function count_recent_logins() {
    local since_date
    since_date=$(date -d 'yesterday' '+%b %e')
    last -F | grep "${since_date}" | wc -l
}

# –§—É–Ω–∫—Ü–∏—è: –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–ø-5 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
function top_users() {
    last | awk '{print $1}' \
         | sort \
         | uniq -c \
         | sort -nr \
         | head -n 5
}

# –û—Å–Ω–æ–≤–Ω–æ–π –±–ª–æ–∫
log "üë• –ù–∞—á–∏–Ω–∞–µ–º —Å–±–æ—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤—Ö–æ–¥–æ–≤..."

LOGIN_COUNT=$(count_recent_logins)
USER_RANKING=$(top_users)

{
    echo -e "üìÜ $(date '+%Y-%m-%d %H:%M:%S')"
    echo -e "üî¢ –í—Ö–æ–¥–æ–≤ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞: ${LOGIN_COUNT}"
    echo -e "üèÜ –¢–æ–ø-5 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:"
    echo "${USER_RANKING}"
    echo "----------------------------------------"
} >> "${LOG_PATH}"

log "‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞."

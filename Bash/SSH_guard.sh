#!/usr/bin/env bash

# ============================================
# –û–ø–∏—Å–∞–Ω–∏–µ: –ê–Ω–∞–ª–∏–∑ –Ω–µ—É–¥–∞—á–Ω—ã—Ö SSH-–ø–æ–ø—ã—Ç–æ–∫ –∏ –≤—ã–≤–æ–¥ –¢–û–ü-10 IP-–∞–¥—Ä–µ—Å–æ–≤
# ============================================

# –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –ª–æ–≥–æ–≤ (CentOS: /var/log/secure)
readonly AUTH_LOG="/var/log/auth.log"
# –°–∫–æ–ª—å–∫–æ IP-–∞–¥—Ä–µ—Å–æ–≤ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å
readonly TOPN=10

# –§—É–Ω–∫—Ü–∏—è: –í—ã–≤–æ–¥ –∑–∞–≥–æ–ª–æ–≤–∫–∞
print_header() {
    echo -e "üîç –ê–Ω–∞–ª–∏–∑ –Ω–µ—É–¥–∞—á–Ω—ã—Ö SSH-–ø–æ–ø—ã—Ç–æ–∫"
    echo -e "üö® –¢–æ–ø ${TOPN} IP-–∞–¥—Ä–µ—Å–æ–≤ —Å –æ—à–∏–±–∫–∞–º–∏ –≤—Ö–æ–¥–∞:"
}

# –§—É–Ω–∫—Ü–∏—è: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏ –ø–æ–¥—Å—á—ë—Ç –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫
analyze_failures() {
    grep -E "Failed password for" "${AUTH_LOG}" \
        | grep -oP '(?<=from )[0-9.]+(?= port)' \
        | sort \
        | uniq -c \
        | sort -rn \
        | head -n "${TOPN}"
}

# –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞
print_header
analyze_failures

# –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ
echo -e "‚úÖ –ì–æ—Ç–æ–≤–æ!"
